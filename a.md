# 概要

これは.NET.frameworkでコードカバレッジを取得して、それをGitLabのマージリクエストで確認する方法を書s紹介します。

## 目次

## GitLabでコードカバレッジを確認する

GitLabのマージリクエストなどでコードカバレッジを確認する方法を紹介します。

### 総カバレッジ率を確認する

マージリクエストを開いてください。パイプライン #.... のすぐ下辺りで総カバレッジ率を確認できます。

![Alt text](image.png)

総カバレッジ率は、マージリクエスト以外にも、GitLabプロジェクトのサイドメニューの分析->リポジトリから推移グラフで確認できます。

![Alt text](image-1.png)

手順

1.お試しのマージリクエストを開きます
2.1 件の公開されたアーティファクトを表示をクリックして開きます
3.coverage -> coverage -> index.html とクリックすると、詳細なカバレッジレポートが表示されます

### 詳細なコードカバレッジレポートを確認する

詳細なコードカバレッジレポートをGitLabから確認できます。(一般的にHTML形式)に変換するのが一般的です

![Alt text](image-2.png)

![Alt text](image-3.png)

### 単体テスト結果を確認する(おまけ)

GitLabは単体テスト結果を表示する機能があります。コードカバレッジとは違いますが、せっかくなのでまとめて紹介します。

手順

1.お試しのマージリクエストを開きます
2.テストの要約...のところの展開をクリックすると、マージリクエストで変わったテスト結果だけが表示されます

![Alt text](image-4.png)

レポート全体を見るをクリックすると、全ての詳細な単体テスト結果にアクセスできます。

![Alt text](image-5.png)

![Alt text](image-6.png)

マージリクエストからだけでなく、各パイプラインのテストタブでも確認できます。

### GitLabで単体テストの実行

GitLabには単体テストの結果を表示する機能があります。コードカバレッジではありませんが、せっかくですのでこの機能の設定方法も紹介します。

![Alt text](image-7.png)
マージリクエストでの単体テスト結果要約

![Alt text](image-8.png)
単体テスト結果詳細

GitLabで単体テストの結果を確認するためには、レポートがJUnit形式でなければなりませんので、JUnit形式で出力するテストレポーターを組み込みます。

テストレポーターはいくつかありますが、JunitXml.TestLoggerはGitLab CIでの設定例も紹介されているので、採用します。


まずはテストプロジェクトにJunitXml.TestLoggerを追加します。


公式サイトのGitLab CI/CD の推奨設定を参考にしてJUnit形式のレポートを出力します。次のコマンドを実行します。

ファイルartifacts\ConsumptionTax.Tests-test-result.xmlが出力されていることを確認してください。(レポートファイルの出力先は、カレントディレクトリではなく、各テストプロジェクトからの相対ディレクトリなことに注意してください)

そして、GitLab CIに組み込みます。.gitlab-ci.ymlファイルを次のように作成します。

artifactsキーワードを使うと、アーティファクトをアップロードしてGitLabで確認できるようになります。reportsキーワードは特別なアーティファクトのアップロードに用いられます。例えば、junitキーワードを使ってJUnit形式のレポートをアップロードをすると、そのファイルをGitLabが解析し、テスト結果をGitLabで確認することができるようになります。

もちろん、junitキーワード以外にも、コードカバレッジレポートをアップロードするためのcoberturaキーワードなど、他にもあります。

.gitlab-ci.ymlファイルの作成が終わったら、コミットしてGitLabにプッシュしてください。GitLab CIパイプラインが開始され、単体テストが実行されます。

GitLabの該当プロジェクトのサイドメニューからCI/CD ->パイプラインをクリックし、一番上にある最新のパイプラインをクリックしてください。そこのテストタブを開くと単体テストの詳細を見ることができます。

![Alt text](image-9.png)

コードカバレッジを取る
.NETの単体テストでコードカバレッジを取る方法は、.NETの公式ドキュメントの単体テストにコードカバレッジを使用するに書かれています。こちらを参考にします。


次のコマンドを実行します。

dotnet test --collect:"XPlat Code Coverage"
ファイルConsumptionTax.Tests\TestResults\....\coverage.cobertura.xmlが出力されているはずです。

このコードカバレッジのXMLファイルは生データで、そのままでは役に立ちません。GitLabでわかりやすく表示する設定をしていきます。



### OSS
